module nijilive.core.render.backends.directx12.dxhelpers;

version (RenderBackendDirectX12) {

version (InDoesRender) {

import core.sys.windows.windef : HRESULT;
import std.exception : enforce;
import std.format : format;

import aurora.directx.com : uuidof, GUID;
import aurora.directx.d3d12;
import aurora.directx.d3d.d3dcommon : D3D_FEATURE_LEVEL;
import aurora.directx.dxgi.dxgiformat : DXGI_FORMAT;
import wincom = core.sys.windows.com;

/// Returns true when the HRESULT indicates success.
bool dxSucceeded(HRESULT hr) @safe pure nothrow {
    return hr >= 0;
}

/// Returns true when the HRESULT indicates failure.
bool dxFailed(HRESULT hr) @safe pure nothrow {
    return hr < 0;
}

/// Formats a descriptive HRESULT message.
string hrMessage(HRESULT hr) {
    return format("0x%08X", cast(uint)hr);
}

/// Throws if the HRESULT represents a failure.
void enforceHr(HRESULT hr, lazy string message) {
    enforce(dxSucceeded(hr), message ~ " (hr=" ~ hrMessage(hr) ~ ")");
}

alias WinGUID = wincom.GUID;
alias AuroraGUID = GUID;

const(WinGUID)* iid(T)() {
    return &uuidof!T;
}

private AuroraGUID convertToAuroraGuid(const WinGUID guid) {
    AuroraGUID result;
    result.Data1 = guid.Data1;
    result.Data2 = guid.Data2;
    result.Data3 = guid.Data3;
    result.Data4[] = guid.Data4[];
    return result;
}

const(AuroraGUID)* iidAurora(T)() {
    static immutable AuroraGUID guidValue = convertToAuroraGuid(uuidof!T);
    return &guidValue;
}

private enum uint D3D12_SHADER_COMPONENT_MAPPING_ALWAYS_SET_BIT_AVOIDING_ZEROMEM_MISTAKES =
    1u << (D3D12_SHADER_COMPONENT_MAPPING_SHIFT * 4);

pure nothrow @safe uint d3d12EncodeShader4ComponentMapping(uint src0, uint src1, uint src2, uint src3) {
    return ((src0 & D3D12_SHADER_COMPONENT_MAPPING_MASK) |
        ((src1 & D3D12_SHADER_COMPONENT_MAPPING_MASK) << D3D12_SHADER_COMPONENT_MAPPING_SHIFT) |
        ((src2 & D3D12_SHADER_COMPONENT_MAPPING_MASK) << (D3D12_SHADER_COMPONENT_MAPPING_SHIFT * 2)) |
        ((src3 & D3D12_SHADER_COMPONENT_MAPPING_MASK) << (D3D12_SHADER_COMPONENT_MAPPING_SHIFT * 3)) |
        D3D12_SHADER_COMPONENT_MAPPING_ALWAYS_SET_BIT_AVOIDING_ZEROMEM_MISTAKES);
}

enum uint D3D12_DEFAULT_SHADER_4_COMPONENT_MAPPING = d3d12EncodeShader4ComponentMapping(0, 1, 2, 3);
enum float D3D12_FLOAT32_MAX = float.max;

enum D3D12_HEAP_TYPE D3D12_HEAP_TYPE_DEFAULT = D3D12_HEAP_TYPE.DEFAULT;
enum D3D12_HEAP_TYPE D3D12_HEAP_TYPE_UPLOAD = D3D12_HEAP_TYPE.UPLOAD;
enum D3D12_HEAP_TYPE D3D12_HEAP_TYPE_READBACK = D3D12_HEAP_TYPE.READBACK;
enum D3D12_CPU_PAGE_PROPERTY D3D12_CPU_PAGE_PROPERTY_UNKNOWN = D3D12_CPU_PAGE_PROPERTY.UNKNOWN;
enum D3D12_MEMORY_POOL D3D12_MEMORY_POOL_UNKNOWN = D3D12_MEMORY_POOL.POOL_UNKNOWN;
enum D3D12_DESCRIPTOR_HEAP_TYPE D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV = D3D12_DESCRIPTOR_HEAP_TYPE.CBV_SRV_UAV;
enum D3D12_DESCRIPTOR_HEAP_TYPE D3D12_DESCRIPTOR_HEAP_TYPE_RTV = D3D12_DESCRIPTOR_HEAP_TYPE.RTV;
enum D3D12_DESCRIPTOR_HEAP_TYPE D3D12_DESCRIPTOR_HEAP_TYPE_DSV = D3D12_DESCRIPTOR_HEAP_TYPE.DSV;
enum D3D12_DESCRIPTOR_HEAP_FLAGS D3D12_DESCRIPTOR_HEAP_FLAG_NONE = D3D12_DESCRIPTOR_HEAP_FLAGS.NONE;
enum D3D12_DESCRIPTOR_HEAP_FLAGS D3D12_DESCRIPTOR_HEAP_FLAG_SHADER_VISIBLE = D3D12_DESCRIPTOR_HEAP_FLAGS.SHADER_VISIBLE;
enum D3D12_HEAP_FLAGS D3D12_HEAP_FLAG_NONE = D3D12_HEAP_FLAGS.NONE;
enum D3D12_RESOURCE_DIMENSION D3D12_RESOURCE_DIMENSION_BUFFER = D3D12_RESOURCE_DIMENSION.BUFFER;
enum D3D12_RESOURCE_DIMENSION D3D12_RESOURCE_DIMENSION_TEXTURE2D = D3D12_RESOURCE_DIMENSION.TEXTURE2D;
enum D3D12_RESOURCE_FLAGS D3D12_RESOURCE_FLAG_NONE = cast(D3D12_RESOURCE_FLAGS)0;
enum D3D12_RESOURCE_FLAGS D3D12_RESOURCE_FLAG_ALLOW_RENDER_TARGET = D3D12_RESOURCE_FLAGS.ALLOW_RENDER_TARGET;
enum D3D12_RESOURCE_FLAGS D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL = D3D12_RESOURCE_FLAGS.ALLOW_DEPTH_STENCIL;
enum D3D12_TEXTURE_LAYOUT D3D12_TEXTURE_LAYOUT_UNKNOWN = D3D12_TEXTURE_LAYOUT.LAYOUT_UNKNOWN;
enum D3D12_TEXTURE_LAYOUT D3D12_TEXTURE_LAYOUT_ROW_MAJOR = D3D12_TEXTURE_LAYOUT.LAYOUT_ROW_MAJOR;
enum D3D12_RESOURCE_STATES D3D12_RESOURCE_STATE_GENERIC_READ = D3D12_RESOURCE_STATES.GENERIC_READ;
enum D3D12_RESOURCE_STATES D3D12_RESOURCE_STATE_COPY_DEST = D3D12_RESOURCE_STATES.COPY_DEST;
enum D3D12_RESOURCE_STATES D3D12_RESOURCE_STATE_COPY_SOURCE = D3D12_RESOURCE_STATES.COPY_SOURCE;
enum D3D12_RESOURCE_STATES D3D12_RESOURCE_STATE_PIXEL_SHADER_RESOURCE = D3D12_RESOURCE_STATES.PIXEL_SHADER_RESOURCE;
enum D3D12_RESOURCE_STATES D3D12_RESOURCE_STATE_NON_PIXEL_SHADER_RESOURCE = D3D12_RESOURCE_STATES.NON_PIXEL_SHADER_RESOURCE;
enum D3D12_RESOURCE_STATES D3D12_RESOURCE_STATE_VERTEX_AND_CONSTANT_BUFFER = D3D12_RESOURCE_STATES.VERTEX_AND_CONSTANT_BUFFER;
enum D3D12_RESOURCE_STATES D3D12_RESOURCE_STATE_DEPTH_WRITE = D3D12_RESOURCE_STATES.DEPTH_WRITE;
enum D3D12_RESOURCE_STATES D3D12_RESOURCE_STATE_RENDER_TARGET = D3D12_RESOURCE_STATES.RENDER_TARGET;
enum D3D12_COMMAND_LIST_TYPE D3D12_COMMAND_LIST_TYPE_DIRECT = D3D12_COMMAND_LIST_TYPE.DIRECT;
enum D3D12_COMMAND_QUEUE_FLAGS D3D12_COMMAND_QUEUE_FLAG_NONE = D3D12_COMMAND_QUEUE_FLAGS.NONE;
enum D3D12_FENCE_FLAGS D3D12_FENCE_FLAG_NONE = D3D12_FENCE_FLAGS.NONE;
enum D3D12_DESCRIPTOR_RANGE_TYPE D3D12_DESCRIPTOR_RANGE_TYPE_SRV = D3D12_DESCRIPTOR_RANGE_TYPE.SRV;
enum D3D12_SHADER_VISIBILITY D3D12_SHADER_VISIBILITY_VERTEX = D3D12_SHADER_VISIBILITY.VERTEX;
enum D3D12_SHADER_VISIBILITY D3D12_SHADER_VISIBILITY_PIXEL = D3D12_SHADER_VISIBILITY.PIXEL;
enum D3D12_ROOT_PARAMETER_TYPE D3D12_ROOT_PARAMETER_TYPE_DESCRIPTOR_TABLE = cast(D3D12_ROOT_PARAMETER_TYPE)D3D12_ROOT_PARAMETER_TYPE.TYPE_DESCRIPTOR_TABLE;
enum D3D12_ROOT_PARAMETER_TYPE D3D12_ROOT_PARAMETER_TYPE_CBV = cast(D3D12_ROOT_PARAMETER_TYPE)D3D12_ROOT_PARAMETER_TYPE.TYPE_CBV;
enum D3D12_BUFFER_SRV_FLAGS D3D12_BUFFER_SRV_FLAG_NONE = D3D12_BUFFER_SRV_FLAGS.NONE;
enum D3D12_RESOURCE_BARRIER_TYPE D3D12_RESOURCE_BARRIER_TYPE_TRANSITION = D3D12_RESOURCE_BARRIER_TYPE.TRANSITION;
enum D3D12_RESOURCE_BARRIER_FLAGS D3D12_RESOURCE_BARRIER_FLAG_NONE = D3D12_RESOURCE_BARRIER_FLAGS.NONE;
enum D3D12_SRV_DIMENSION D3D12_SRV_DIMENSION_BUFFER = D3D12_SRV_DIMENSION.BUFFER;
enum D3D12_SRV_DIMENSION D3D12_SRV_DIMENSION_TEXTURE2D = D3D12_SRV_DIMENSION.TEXTURE2D;
enum D3D12_TEXTURE_ADDRESS_MODE D3D12_TEXTURE_ADDRESS_MODE_CLAMP = D3D12_TEXTURE_ADDRESS_MODE.CLAMP;
enum D3D12_FILTER D3D12_FILTER_MIN_MAG_MIP_LINEAR = D3D12_FILTER.MIN_MAG_MIP_LINEAR;
enum D3D12_COMPARISON_FUNC D3D12_COMPARISON_FUNC_ALWAYS = D3D12_COMPARISON_FUNC.ALWAYS;
enum D3D12_STATIC_BORDER_COLOR D3D12_STATIC_BORDER_COLOR_OPAQUE_WHITE = D3D12_STATIC_BORDER_COLOR.OPAQUE_WHITE;
enum D3D12_PRIMITIVE_TOPOLOGY_TYPE D3D12_PRIMITIVE_TOPOLOGY_TYPE_TRIANGLE = D3D12_PRIMITIVE_TOPOLOGY_TYPE.TRIANGLE;
enum D3D12_INPUT_CLASSIFICATION D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA = D3D12_INPUT_CLASSIFICATION.PER_VERTEX_DATA;
enum D3D12_CULL_MODE D3D12_CULL_MODE_NONE = D3D12_CULL_MODE.NONE;
enum D3D12_FILL_MODE D3D12_FILL_MODE_SOLID = D3D12_FILL_MODE.D3D12_FILL_MODE_SOLID;
enum D3D12_COLOR_WRITE_ENABLE D3D12_COLOR_WRITE_ENABLE_ALL = D3D12_COLOR_WRITE_ENABLE.ALL;
enum D3D12_BLEND D3D12_BLEND_ONE = D3D12_BLEND.ONE;
enum D3D12_BLEND D3D12_BLEND_INV_SRC_ALPHA = D3D12_BLEND.INV_SRC_ALPHA;
enum D3D12_BLEND_OP D3D12_BLEND_OP_ADD = D3D12_BLEND_OP.ADD;
enum D3D12_ROOT_SIGNATURE_FLAGS D3D12_ROOT_SIGNATURE_FLAG_ALLOW_INPUT_ASSEMBLER_INPUT_LAYOUT =
    D3D12_ROOT_SIGNATURE_FLAGS.ALLOW_INPUT_ASSEMBLER_INPUT_LAYOUT;
enum D3D12_TEXTURE_COPY_TYPE D3D12_TEXTURE_COPY_TYPE_PLACED_FOOTPRINT = D3D12_TEXTURE_COPY_TYPE.PLACED_FOOTPRINT;
enum D3D12_TEXTURE_COPY_TYPE D3D12_TEXTURE_COPY_TYPE_SUBRESOURCE_INDEX = D3D12_TEXTURE_COPY_TYPE.SUBRESOURCE_INDEX;

enum DXGI_FORMAT DXGI_FORMAT_UNKNOWN = DXGI_FORMAT.UNKNOWN;
enum DXGI_FORMAT DXGI_FORMAT_R8_UNORM = DXGI_FORMAT.R8_UNORM;
enum DXGI_FORMAT DXGI_FORMAT_R8G8_UNORM = DXGI_FORMAT.R8G8_UNORM;
enum DXGI_FORMAT DXGI_FORMAT_R8G8B8A8_UNORM = DXGI_FORMAT.R8G8B8A8_UNORM;
enum DXGI_FORMAT DXGI_FORMAT_R16_UINT = DXGI_FORMAT.R16_UINT;
enum DXGI_FORMAT DXGI_FORMAT_R16G16B16A16_FLOAT = DXGI_FORMAT.R16G16B16A16_FLOAT;
enum DXGI_FORMAT DXGI_FORMAT_R32_FLOAT = DXGI_FORMAT.R32_FLOAT;
enum DXGI_FORMAT DXGI_FORMAT_D24_UNORM_S8_UINT = DXGI_FORMAT.D24_UNORM_S8_UINT;
enum DXGI_FORMAT DXGI_FORMAT_D32_FLOAT = DXGI_FORMAT.D32_FLOAT;

enum D3D_FEATURE_LEVEL D3D_FEATURE_LEVEL_12_0 = D3D_FEATURE_LEVEL.LEVEL_12_0;
enum D3D_FEATURE_LEVEL D3D_FEATURE_LEVEL_12_1 = D3D_FEATURE_LEVEL.LEVEL_12_1;

}

}
